[仙人指路](https://yeasy.gitbook.io/docker_practice/image/build)

### 基础构建

`docker build` 命令用于根据 Dockerfile 构建镜像。

**基本语法**：

``` Bash
docker build [OPTIONS] <PATH> | <URL>
```

- `PATH`：构建上下文的路径。通常是包含 Dockerfile 的当前目录。
    
- `URL`：可以是一个 Git 仓库的 URL，Docker 会自动克隆并构建。
    

#### 常用选项

- `-t, --tag <名称>:<标签>`：为构建的镜像命名和打标签。**强烈推荐使用**。
    
    - 例如：`docker build -t my-web-app:v1.0 .`
        
- `-f, --file <路径>`：指定 Dockerfile 文件的路径。如果 Dockerfile 不在构建上下文的根目录，这个选项就很有用。
    
    - 例如：`docker build -f Dockerfile.prod -t my-app .`
        
- `--no-cache`：在构建时不使用缓存。这会强制重新执行 Dockerfile 中的所有指令。
    
- `--build-arg <变量>`：在构建过程中传递环境变量。常用于传递敏感信息或版本号。
    
    - 例如：`docker build --build-arg VERSION=1.2.3 .`
        
    - 在 Dockerfile 中需用 `ARG` 声明：`ARG VERSION`
        

---

### 多阶构建

构建 Docker 镜像的核心目标是：**最小化镜像体积，最大化安全性和可移植性**。多阶段构建是实现这一目标的最有效方法。

#### 1. 多阶段构建：理念

多阶段构建的核心是利用多个 `FROM` 语句。每个 `FROM` 都代表一个构建阶段，但只有**最后一个阶段的镜像**会被最终保留。

- **构建阶段**：使用一个包含所有构建工具（如编译器、包管理器等）的庞大基础镜像。
    
- **运行时阶段**：使用一个只包含应用运行所需依赖的极小基础镜像。
    

这样做的优势是：你可以在一个 Dockerfile 中完成所有编译、测试和打包工作，而最终的镜像只会包含最终应用，**没有任何中间过程的“垃圾”**，比如编译工具或源代码。

#### 2. Dockerfile 模板与示例

下面是一个典型的 Go 语言应用的多阶段构建 Dockerfile 模板。这个模式可以应用于任何需要编译或打包的语言，如 Java、Python（打包 `wheel` 或 `venv`）、Node.js 等。

``` Dockerfile
# Step 1: Build Stage
# 使用一个包含完整构建环境的镜像
FROM golang:1.19-alpine AS build

# 设置工作目录
WORKDIR /app

# 复制 Go 模块依赖文件，并下载
# 这样可以利用缓存，因为 go.mod 很少改变
COPY go.mod go.sum ./
RUN go mod download

# 复制所有源代码
COPY . .

# 编译应用，并禁用 CGO
# CGO_ENABLED=0 是为了创建完全静态链接的可执行文件
RUN go build -o main .

# Step 2: Final (Production) Stage
# 使用一个非常小的、干净的基础镜像
FROM alpine:3.16

# 设置工作目录
WORKDIR /root/

# 从上一个构建阶段（名为 "build"）复制编译好的可执行文件
COPY --from=build /app/main .

# 暴露端口（可选）
EXPOSE 8080

# 容器启动时运行的命令
CMD ["./main"]
```

#### 3. 关键指令详解

- `FROM <镜像> AS <阶段名>`: `AS` 关键字为构建阶段命名，方便后续引用。这是多阶段构建的标志。
    
- `COPY --from=<阶段名> <源路径> <目标路径>`: 这是多阶段构建的精髓。它允许你从**另一个阶段**复制文件，而不是从本地文件系统。
    
- `WORKDIR`: 始终使用 `WORKDIR` 来设置工作目录，而不是在 `RUN` 指令中频繁使用 `cd`。这能让 Dockerfile 更清晰。
    
- `CMD` 和 `ENTRYPOINT`:
    
    - `CMD` 用于指定容器启动时要执行的**默认命令**。
        
    - `ENTRYPOINT` 则用于指定容器的主命令，`CMD` 中的内容会作为参数传递给它。大多数时候，使用 `CMD` 即可。
        

#### 4. 构建命令

构建镜像的命令依然是 `docker build`，但在多阶段构建中，你只需关注最终结果。

``` Bash
# -t 指定镜像名称和标签
# . 代表当前目录是构建上下文
docker build -t my-go-app:v1.0 .
```

Docker 守护进程会依次执行所有阶段，但最终只会生成和保存最后一个阶段的镜像。你无法看到中间阶段的镜像，除非你在 Dockerfile 中明确为它们打上标签。
