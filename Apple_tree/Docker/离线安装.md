[官网下载地址](https://download.docker.com/)

## 部署

- 解压安装

``` bash
 wget https://download.docker.com/linux/static/stable/x86_64/docker-24.0.7.tgz
 tar -zxf docker-24.0.7.tgz
 cp docker/* /usr/bin/
 ```

- 配置docker服务

``` bash
cat <<EOF > /etc/systemd/system/docker.service
[Unit]
​
Description=Docker Application Container Engine
​
Documentation=https://docs.docker.com
​
After=network-online.target firewall.service
​
Wants=network-online.target
​
[Service]
​
Type=notify
​
#the default is not to use systemd for cgroups because the delegay issues still
​
#exists and systemd currently does not support the cgroup feature set required
​
#for containers run by docker
​
ExecStart=/usr/bin/dockerd
​
ExecReload=/bin/kill -s HUP $MAINPID
​
#Having non-zero Limit*s causes performance problems due to accounting overhead
​
#in the kernel. We recommend using cgroups to do container-local accounting.
​
LimitNOFILE=infinity
​
LimitNPROC=infinity
​
LimitCORE=infinity
​
#Uncomment TasksMax if your systemd version supports it.
​
#Only Systemd 226 and above support this version
​
#TasksMax=infinity
​
TimeoutStartSec=0
​
#set delegate yes so that systemd does not reset the cgroups of docker containers
​
Delegate=yes
​
#kill only the docker process, not all process in the cgroup
​
KillMode=process
​
#restart the docker process if it exits prematurely
​
Restart=on-failure
​
StartLimitBurst=3
​
StartLimitInterval=60s
​
[Install]
​
WantedBy=multi-user.target
EOF
```

- 添加权限

``` bash
chmod +x /etc/systemd/system/docker.service 
#重新加载配置（每次修改文件后需执行）
systemctl daemon-reload   
systemctl start docker.service
systemctl status docker.service
#使服务开启自启
systemctl enable docker.service     
```

## 配置管理

配置 `daemon.json` 文件是定制 Docker 守护进程行为的核心方式，它允许你调整网络、镜像存储、日志等多个方面。下面我将详细为你列出所有常用的配置项，并解释它们的作用。

---

### `daemon.json` 配置文件的位置

首先，你需要知道 `daemon.json` 文件通常位于哪里：

- **Linux**: `/etc/docker/daemon.json`
    
- **Windows Server**: `C:\ProgramData\docker\config\daemon.json`
    
- **macOS / Windows Desktop (Docker Desktop)**: Docker Desktop 有一个图形化界面来配置这些选项，但你也可以在特定目录下找到这个文件。通常不建议手动修改，而是使用 Docker Desktop 的设置界面。
    

如果文件不存在，你可以手动创建一个。在修改或创建后，记得**重启 Docker 服务**才能使配置生效。

``` bash
# 在 Linux 上重启 Docker 服务
sudo systemctl restart docker
```

---

### 常用配置项详解

`daemon.json` 文件是一个标准的 JSON 格式文件，所有的配置项都以键值对的形式存在。

#### 1. 镜像加速器 (`registry-mirrors`)

这是最常用的配置项，尤其是在中国大陆，可以显著提高拉取 Docker 镜像的速度。

- **配置示例**:
    
``` JSON
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
```
    
- **作用**: 指定一个或多个镜像加速地址。当从 Docker Hub 拉取镜像时，Docker 会首先尝试从这些加速地址获取，而不是直接连接到官方 Hub，这通常会更快。
    

#### 2. 日志驱动 (`log-driver`) 和日志选项 (`log-opts`)

用于全局配置所有容器的日志收集方式。

- **配置示例**:
    
``` JSON
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```
    
- **`log-driver` 作用**: 设置默认的日志驱动。常见的选项有：
    
    - `json-file`: 默认驱动，将日志以 JSON 格式写入文件。
        
    - `syslog`: 将日志发送到 syslog 服务。
        
    - `journald`: 将日志发送到 systemd 的 journald 服务。
        
    - `none`: 不记录任何日志。
        
- **`log-opts` 作用**: 为日志驱动提供额外的选项。上面的例子中，`max-size` 限制每个日志文件最大为 10MB，`max-file` 限制最多保留 3 个日志文件，这对于防止日志文件无限制增长非常有用。
    

#### 3. 数据根目录 (`data-root`)

更改 Docker 存储所有数据（镜像、容器、卷等）的位置。

- **配置示例**:
    
``` JSON
    {
      "data-root": "/data/docker"
    }
```
    
- **作用**: 默认情况下，Docker 的数据存储在 `/var/lib/docker`。当你需要将这些数据迁移到一个更大的磁盘分区时，这个配置项就非常有用。**修改此项前，请务必停止 Docker 服务，并将原有 `/var/lib/docker` 目录下的所有内容移动到新的目录。**
    

#### 4. 存储驱动 (`storage-driver`)

在较旧的 Docker 版本中，这个配置项用于选择存储后端，但在新版本中，Docker 默认使用 `overlay2` 并且不推荐手动更改。

- **配置示例**:
    
``` JSON
{
  "storage-driver": "overlay2"
}
```
    
- **作用**: 指定 Docker 用于管理镜像和容器的存储驱动。`overlay2` 是目前最推荐且性能最好的驱动。一般情况下，你不需要手动配置它。
    

#### 5. 绑定地址 (`bind-addr`)

配置 Docker 守护进程监听的地址和端口。

- **配置示例**:
    
``` JSON
{
  "hosts": ["tcp://0.0.0.0:2375", "unix:///var/run/docker.sock"]
}
```
    
- **作用**: 允许你通过网络（而非仅通过本地套接字文件）与 Docker 守护进程通信。`tcp://0.0.0.0:2375` 表示监听所有网络接口的 2375 端口。**注意：这会带来安全风险，因为它允许任何人连接到你的 Docker 守护进程。通常，你只会出于特定目的（如远程管理）才启用它，并且会使用 TLS/SSL 证书来加密通信。**
    

#### 6. 容器运行时 (`runtimes`)

配置额外的容器运行时，例如 `kata-containers` 或 `gVisor`，用于提供更强的隔离性。

- **配置示例**:
    
``` JSON
{
  "runtimes": {
    "kata-runtime": {
      "path": "/usr/bin/kata-runtime"
    }
  }
}
```
    
- **作用**: 允许你指定自定义的运行时，并通过 `--runtime` 标志在 `docker run` 命令中使用，例如 `docker run --runtime=kata-runtime ...`。这对于需要更高安全性和隔离性的场景非常有用。
    

#### 7. 其他常用配置项

- `insecure-registries`:
    
``` JSON
{
  "insecure-registries": ["my-private-registry.com:5000"]
}
```
    
    - **作用**: 指定一个或多个不使用 HTTPS 加密的私有仓库地址。在私有网络中部署内部镜像仓库时非常方便。
        
- `default-ulimits`:
    
``` JSON
{
  "default-ulimits": {
    "nofile": {
      "hard": 65536,
      "soft": 65536
    }
  }
}
```
    
    - **作用**: 为所有新建的容器设置默认的 `ulimit` 参数。例如，`nofile` 用于控制容器可以打开的最大文件数。
        
- `bridge`:
     
``` JSON
{
  "bip": "172.18.0.1/16"
}
 ```
    
    - **作用**: 配置 Docker 默认网桥（`docker0`）的 IP 地址和子网掩码。当你需要避免与宿主机或其他网络服务产生 IP 地址冲突时，这个配置项很有用。
        

---

### 完整的 `daemon.json` 示例

下面是一个包含多种配置项的完整示例，供你参考：


``` JSON
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ],
  "data-root": "/data/docker",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "5"
  },
  "insecure-registries": [
    "my-private-registry.com:5000"
  ],
  "default-ulimits": {
    "nofile": {
      "hard": 65536,
      "soft": 65536
    }
  },
  "bip": "172.19.0.1/16"
}
```

请记住，每次修改 `daemon.json` 文件后，都必须重启 Docker 守护进程才能让配置生效。在生产环境中，请谨慎修改，并在修改前做好备份。

## 授权管理

- 为其它用户添加docker使用权限

``` bash
groupadd docker
gpasswd -a $user docker
newgrp docker
```
