> [!tip] SYN_RECV (TCP半连接)
> 在 TCP 三次握手的过程中，`SYN_RECV`（也称为 `SYN_RCVD`）状态表示服务器已经收到了客户端的 SYN 包并回送了 SYN-ACK，正在等待客户端最后的一次 ACK 确认。
> 如果这一状态的连接数过高，通常意味着服务器正面临 **SYN Flood 攻击**，或者网络链路存在严重质量问题。

---

## 一、 `SYN_RECV` 过高会导致的问题

当服务器的半连接队列（SYN Queue）被占满时，会产生以下后果：

1. **正常用户无法建立连接**：服务器无法再接收新的 SYN 请求，导致合法用户连接超时，业务直接不可用。
    
2. **系统资源消耗**：虽然单个半连接占用的内存较小，但大量积压会消耗内核内存资源。
    
3. **响应延迟增加**：内核处理连接队列的压力增大，可能导致 CPU 占用率升高，系统整体响应变慢。
    

---

## 二、 排查方法

首先，确认当前 `SYN_RECV` 的具体数量：

``` Bash
# 查看各个状态的连接数
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
# 或者使用 ss 命令（更快）
ss -ant | awk '{print $1}' | sort | uniq -c
```

---

## 三、 处理方法与优化方案

处理 `SYN_RECV` 过高问题通常需要从**内核参数优化**和**外部防护**两个维度入手。

### 1. 开启 SYN Cookies (最有效的防御手段)

这是防御 SYN Flood 攻击的核心技术。开启后，服务器在同步队列满时，不再将连接存入队列，而是根据算法生成一个 Cookie 发回客户端，只有验证到合法的 ACK 后才会分配资源。

- **操作**：编辑 `/etc/sysctl.conf`
    
    ``` Bash
    net.ipv4.tcp_syncookies = 1
    ```
    

### 2. 调整半连接队列大小

适当增大队列容量，让服务器能承载更多的等待连接。

- **参数**：
    
    ``` Bash
    net.ipv4.tcp_max_syn_backlog = 4096  # 根据内存情况增加，如 8192 或更高
    ```
    

### 3. 减少 SYN-ACK 重传次数

默认情况下，服务器会重试多次发送 SYN-ACK。减少重试次数可以加快半连接的自动释放速度。

- **参数**：
    
    ``` Bash
    net.ipv4.tcp_synack_retries = 2  # 默认通常是 5，减小到 1 或 2
    ```
    

### 4. 缩短半连接超时时间

通过减少 TCP 保活探测等相关时间，让系统更快回收无效连接。

- **参数**：
    
    ```
    net.ipv4.tcp_keepalive_time = 600
    ```
    

> **注意**：修改完 `sysctl.conf` 后，请执行 `sysctl -p` 使其立即生效。

---

## 四、 进阶防护

如果上述内核优化仍无法抵御攻击，建议采取以下措施：

- **硬件防火墙/云防火墙**：在基础设施层面拦截异常流量，开启特定的 SYN Proxy 防护。
    
- **iptables/nftables 限制频率**：限制单个 IP 在单位时间内的 SYN 请求频率。
    
    ``` Bash
    # 限制单个IP每秒最多建立10个新连接
    iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 10 -j ACCEPT
    ```
